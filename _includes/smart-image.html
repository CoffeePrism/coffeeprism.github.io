{% comment %}
Smart image component - Automatically selects relevant images based on article content
Usage:
include smart-image.html 
  post=page
  class="additional-class"
  Use the post parameter to pass the article object, and the system will automatically analyze its categories, tags, and title to select the most relevant image
{% endcomment %}

{% assign post = include.post %}
{% assign img_class = include.class | default: "" %}

{% comment %} Set a default image, if random default images are enabled, randomly select one from the default image collection {% endcomment %}
{% if site.use_random_default_images and site.default_images.size > 0 %}
  {% assign random_index = site.time | date: "%s" | modulo: site.default_images.size %}
  {% assign random_index = random_index | plus: post.title.size | modulo: site.default_images.size %}
  {% assign default_image = site.default_images[random_index] %}
{% else %}
  {% assign default_image = site.default_image %}
{% endif %}

{% assign selected_image = default_image %}

{% if post.featured_image %}
  {% assign selected_image = post.featured_image %}
{% else %}
  {% comment %} 1. First try to select an image based on category {% endcomment %}
  {% if post.categories.size > 0 %}
    {% assign category_slug = post.categories.first | strip | slugify %}
    {% if site.data.image_mappings.categories[category_slug] %}
      {% assign selected_image = site.data.image_mappings.categories[category_slug] %}
    {% endif %}
  {% endif %}
  
  {% comment %} 2. If no matching category, try selecting based on tags {% endcomment %}
  {% if selected_image == default_image and post.tags.size > 0 %}
    {% for tag in post.tags %}
      {% assign tag_slug = tag | strip | slugify %}
      {% if site.data.image_mappings.tags[tag_slug] %}
        {% assign selected_image = site.data.image_mappings.tags[tag_slug] %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
  
  {% comment %} 3. If neither categories nor tags match, try selecting based on title keywords {% endcomment %}
  {% if selected_image == default_image and post.title %}
    {% assign title_downcase = post.title | downcase %}
    {% for keyword_mapping in site.data.image_mappings.keywords %}
      {% assign keyword = keyword_mapping[0] %}
      {% if title_downcase contains keyword %}
        {% assign selected_image = keyword_mapping[1] %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

<img 
  src="{{ selected_image | relative_url }}" 
  alt="{{ post.title }}" 
  class="{{ img_class }}"
  loading="lazy"
  onerror="this.onerror=null; this.src='{{ default_image | relative_url }}';"
/> 